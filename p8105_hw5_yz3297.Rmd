---
title: "p8105_hw5_yz3297"
author: "Yue Zhao"
date: "2018年11月6日"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

#Problem 1


```{r,message = FALSE}

data_name= list.files(path = "./data") %>% 
  as.data.frame()
  colnames(data_name) ="file_name"
  
setwd("./data")

df1= map_df(as.character(data_name$file_name), read_csv)

#read in the csv files

df2= data_name %>% 
    mutate(id= substr(file_name,5,6)) %>% 
    mutate(arm= substr(file_name,1,3)) %>% 
    select(id,arm)

#extract id and arm

df3 = cbind(df2,df1) %>%
  gather(key=week,value=value,week_1:week_8) %>%
  mutate(week=substr(week,6,6))

#bind the datasets and make the dataset tidy
```

####I created two datasets:df1 and df2. df1 is to load the content using `map_df` function. df2 is to load the name of the file. Then I binded the two datasets together and called it df3. To make it tidy, I turned df3 from wide to long form using `gather` function. 

```{r}
df3 %>% 
  ggplot(aes(x = as.numeric(week), y = value, color=id)) + 
   labs(
      title = "Spaghetti Plot in Control Group vs Experimental Group",
      x = "Week",
      y = "Value",
      caption = "Data from the hw5 zip file"
    ) +
  geom_line() +
  facet_grid(~arm)
#make a spaghetti plot  

  
```

####Above is the plot of value against time by each participant. In the experimental group, we can see a increasing trend as time goes on. In the control group, we see a flat pattern. 

#Problem 2
```{r,message=FALSE}
homicide_data= read_csv(file="./homicide-data.csv") %>%
   mutate(city_state=paste(city,state,sep=", ")) 

homicide_data
```

####The dataset has `r ncol(homicide_data)` variables and `r nrow(homicide_data)` observations. The main variables are id, date, victim first name, last name, race and age.



```{r}
homicide_data %>% 
   group_by(city_state) %>% 
   count(city_state)
#Above is the total number of homicides in each city

homicide_data %>% 
   filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>% 
   group_by(city_state) %>% 
   count(city_state)

#Above is the total number of unsolved homicides in each city
```

####I printed out several observations of the total homicides and unsolved homicides in each city. 

```{r}
  n1= homicide_data %>% 
    filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>% 
    filter(city_state=="Baltimore, MD") %>% 
    count(city_state)
  
  n2= homicide_data %>% 
    filter(city_state=="Baltimore, MD") %>% 
    count(city_state)
  
  prop.test(n1$n, n2$n) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high) %>% 
  knitr::kable(digits=3)
```

####The point estimate and confidence interval of Baltimore, MD is given above. I calculated the unsolved and total number for Baltimore, MD and then use the function `prop.test`.

```{r}
total_crime = homicide_data %>%
    group_by(city_state) %>%
    summarise(total = n()) 

# total case in a city

unsolved = homicide_data %>%
  filter(disposition %in% c ("Closed without arrest", "Open/No arrest")) %>%
  group_by(city_state)  %>%
  summarise(unsolved = n())
# unsolved case in a city 

overall_crime=left_join(unsolved,total_crime,id=city_state)
```

####I combined the unsolved data and the total crime data into a single dataset called overall_crime. 

```{r}
prop_2= function(x) {
  broom::tidy(prop.test(x$unsolved, x$total)) %>%
    select(estimate, conf.low, conf.high)
}

final_data = nest(overall_crime, unsolved:total) %>%
  mutate(unsolved_prop = map(data, prop_2)) %>% 
  unnest()
```

####I defined a function prop_2 and made the `prop.test` result tidy by using `broom::tidy`. I also nested the unsolved and total number into a list called "data". Then I mapped my data to the final_data and then unnested it. This dataset final_data contains the name of the city, unsolved, total homicides, point estimate and the confidence interval lower and upper bounds. 


```{r}
final_data %>% 
  mutate(city_state = fct_reorder(city_state,estimate,.desc=TRUE)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
        geom_point() +
        labs(title = "Proportion of Unsolved Cases By City",
             x = "City",
             y = "Proportion of Unsolved Cases",
             Caption = "Point Estimate and 95% confidence interval") +
        geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
        coord_flip()

```

####This is the graph showing the estimates and CIs for each city. I switched coordinates between x and y since this looks more tidy than the other way around. 

